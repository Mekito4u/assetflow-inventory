{% extends 'inventory/base.html' %}

{% block title %}Оборудование{% endblock %}

{% block content %}
<div class="stats">
    <div class="stat-card">
        <div>Всего</div>
        <div style="font-size: 24px;">{{ stats.total }}</div>
    </div>
    <div class="stat-card">
        <div>Доступно</div>
        <div style="font-size: 24px; color: #28a745;">{{ stats.available }}</div>
    </div>
    <div class="stat-card">
        <div>Используется</div>
        <div style="font-size: 24px; color: #dc3545;">{{ stats.in_use }}</div>
    </div>
</div>

{% for device in devices %}
    <div class="device-card status-{{ device.status }}">
        <h3>{{ device.model }} ({{ device.inventory_number }})</h3>
        <p>Тип: {{ device.device_type.name }}</p>
        <p>Статус:
            {% if device.status == 'available' %}
                <span style="color: #28a745;">Доступно</span>
            {% elif device.status == 'in_use' %}
                <span style="color: #dc3545;">У сотрудника</span>
            {% else %}
                <span style="color: #6c757d;">На ремонте</span>
            {% endif %}
        </p>

        <div style="margin-top: 10px;">
            {% if device.status == 'available' and user.userprofile.role == 'employee'%}
                <!-- ПРОВЕРКА НА АКТИВНУЮ ЗАЯВКУ -->
                {% with pending_requests=device.request_set.all %}
                    {% for req in pending_requests %}
                        {% if req.status == 'pending' %}
                            <button disabled class="btn" style="background: #6c757d;">
                                ⏳ Есть активная заявка
                            </button>
                        {% endif %}
                    {% empty %}
                        <a href="{% url 'create_request' device.id %}" class="btn">Создать заявку</a>
                    {% endfor %}
                {% endwith %}
            {% endif %}

            {% if device.status == 'in_use' and user.is_authenticated and user.userprofile.role == 'employee' %}
                {% if device.id in user_has_device %}
                    <a href="{% url 'report_breakdown' device.id %}" class="btn" style="background: #dc3545;">Сообщить о поломке</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% empty %}
    <div class="device-card">
        <p>Оборудование не найдено</p>
    </div>
{% endfor %}
{% endblock %}